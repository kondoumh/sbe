<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tauri PoC - sbe</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #0052a3;
    }
    .favs-list {
      margin-top: 20px;
    }
    .fav-item {
      padding: 12px;
      margin: 8px 0;
      background: #f9f9f9;
      border-left: 3px solid #0066cc;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .fav-item:hover {
      background: #e8f0fe;
    }
    .fav-item .project {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .fav-item .page {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
      display: none;
    }
    .status.show {
      display: block;
    }
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    .section {
      margin-bottom: 30px;
    }
    .debug {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Tauri 2.0 PoC - Scrapbox Electron</h1>
    
    <div class="section">
      <h2>Multi-Window Demo</h2>
      <p>Test opening Scrapbox pages in separate windows:</p>
      <button id="openScrapbox">Open Scrapbox.io</button>
      <button id="openHelpJp">Open Help-JP</button>
    </div>

    <div class="section">
      <h2>IPC Command Demo</h2>
      <p>Test fetching favorites from Rust backend:</p>
      <button id="loadFavs">Load Favorites</button>
      <div class="favs-list" id="favsList"></div>
    </div>

    <div class="status" id="status"></div>
    <div class="debug" id="debug">Initializing...</div>
  </div>

  <script type="module">
    const debugEl = document.getElementById('debug');
    const statusEl = document.getElementById('status');
    
    function debug(message) {
      console.log(message);
      debugEl.textContent = message;
    }

    function showStatus(message, isError = false) {
      console.log('Status:', message);
      statusEl.textContent = message;
      statusEl.classList.add('show');
      if (isError) {
        statusEl.classList.add('error');
      } else {
        statusEl.classList.remove('error');
      }
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 3000);
    }

    debug('Checking Tauri environment...');

    // Check if running in Tauri
    if (!window.__TAURI__) {
      debug('ERROR: Not running in Tauri! window.__TAURI__ is undefined');
      showStatus('‚ùå Not running in Tauri environment', true);
    } else {
      debug('‚úì Tauri environment detected');
    }

    try {
      const { invoke } = await import('https://cdn.jsdelivr.net/npm/@tauri-apps/api@2/core');
      debug('‚úì Tauri API loaded from CDN');

      // Test invoke immediately
      try {
        debug('Testing get_favs command...');
        const testFavs = await invoke('get_favs');
        debug(`‚úì get_favs works! Got ${testFavs.length} items`);
        showStatus('‚úì Tauri IPC is working!');
      } catch (err) {
        debug('‚úó get_favs failed: ' + err);
        showStatus('‚ùå IPC test failed: ' + err, true);
      }

      // Multi-window: Open Scrapbox
      document.getElementById('openScrapbox').addEventListener('click', async () => {
        debug('Opening Scrapbox...');
        try {
          await invoke('open_new_window', {
            url: 'https://scrapbox.io',
            title: 'Scrapbox'
          });
          showStatus('‚úì Opened Scrapbox in new window');
        } catch (error) {
          debug('Error: ' + error);
          showStatus('‚úó Error: ' + error, true);
        }
      });

      // Multi-window: Open Help-JP
      document.getElementById('openHelpJp').addEventListener('click', async () => {
        debug('Opening Help-JP...');
        try {
          await invoke('open_new_window', {
            url: 'https://scrapbox.io/help-jp',
            title: 'Scrapbox Help'
          });
          showStatus('‚úì Opened Help-JP in new window');
        } catch (error) {
          debug('Error: ' + error);
          showStatus('‚úó Error: ' + error, true);
        }
      });

      // IPC Command: Load favorites
      document.getElementById('loadFavs').addEventListener('click', async () => {
        debug('Loading favorites...');
        try {
          const favs = await invoke('get_favs');
          debug(`Received ${favs.length} favorites`);
          const favsListEl = document.getElementById('favsList');
          
          favsListEl.innerHTML = favs.map(fav => `
            <div class="fav-item" data-url="${fav.url}">
              <div class="project">${fav.project}</div>
              <div class="page">${fav.page}</div>
            </div>
          `).join('');

          // Add click handlers to open in new window
          document.querySelectorAll('.fav-item').forEach(item => {
            item.addEventListener('click', async () => {
              const url = item.dataset.url;
              const title = item.querySelector('.page').textContent;
              debug(`Opening favorite: ${title}`);
              try {
                await invoke('open_new_window', { url, title });
                showStatus(`‚úì Opened "${title}" in new window`);
              } catch (error) {
                debug('Error: ' + error);
                showStatus('‚úó Error: ' + error, true);
              }
            });
          });

          showStatus(`‚úì Loaded ${favs.length} favorites`);
        } catch (error) {
          debug('Error loading favs: ' + error);
          showStatus('‚úó Error: ' + error, true);
        }
      });

      debug('‚úì All ready - click buttons to test');
    } catch (error) {
      debug('Failed to load Tauri API: ' + error);
      showStatus('‚ùå Failed to load Tauri API: ' + error, true);
    }
  </script>
</body>
</html>
